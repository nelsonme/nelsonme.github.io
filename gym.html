<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Gym Tracker</title>

<style>
  body {
    font-family: system-ui, -apple-system, BlinkMacSystemFont, sans-serif;
    background: #0b0b0b;
    color: #f0f0f0;
    margin: 0;
    padding: 12px;
  }

  h1 {
    font-size: 18px;
    margin-bottom: 12px;
    font-weight: 600;
  }

  .card {
    background: #161616;
    border-radius: 14px;
    padding: 14px;
    margin-bottom: 14px;
    box-shadow: 0 0 0 1px rgba(255,255,255,0.05);
  }

  .card.active {
    box-shadow:
      0 0 0 2px #0aa95c,
      0 8px 24px rgba(0,0,0,0.5);
  }

  .title {
    font-size: 14px;
    opacity: 0.9;
    margin-bottom: 4px;
  }

  .history {
    font-size: 12px;
    opacity: 0.6;
    line-height: 1.4;
    margin-bottom: 10px;
  }

  .history .best {
    color: #e6d27a;
  }

  .row {
    display: flex;
    align-items: center;
    gap: 8px;
    margin-bottom: 6px;
  }

  button {
    background: #2a2a2a;
    color: #fff;
    border: none;
    border-radius: 8px;
    width: 36px;
    height: 36px;
    font-size: 18px;
  }

  button:active {
    background: #3a3a3a;
  }

  .value {
    min-width: 80px;
    text-align: center;
    font-size: 16px;
  }

  .add-set {
    color: #000;
    font-weight: 600;
    width: 110px;
    height: 44px;
    margin-left: auto;
    margin-top: 4px;
    border-radius: 12px;
  }

  .add-ready { background: #0aa95c; }
  .add-in-progress { background: #6fd6a6; }
  .add-complete { background: #888; }

  .set-list {
    font-size: 13px;
    opacity: 0.85;
    margin-top: 6px;
  }

  .pr {
    color: #0aa95c;
  }

  .toast {
    position: fixed;
    bottom: 18px;
    left: 50%;
    transform: translateX(-50%);
    background: #2a2a2a;
    padding: 10px 14px;
    border-radius: 10px;
    display: flex;
    align-items: center;
    gap: 14px;
    opacity: 0;
    pointer-events: none;
    transition: opacity 0.25s ease;
    box-shadow: 0 8px 24px rgba(0,0,0,0.4);
  }

  .toast.show {
    opacity: 1;
    pointer-events: auto;
  }

  .toast button {
    width: auto;
    height: auto;
    padding: 4px 10px;
    font-size: 13px;
    background: #444;
  }
</style>
</head>

<body>

<h1 id="header"></h1>
<div id="app"></div>

<div id="toast" class="toast">
  <span id="toastText">Set added</span>
  <button onclick="undoLast()">Undo</button>
</div>

<script>
const EXERCISES = [
  "Leg Press", "Leg Curl", "Leg Extension",
  "Bicep Curl", "Tricep Extension", "Shoulder Press",
  "Chest Press", "Lat Pulldown", "Machine Row",
  "Abdominal Curl"
];

const WEIGHT_STEP = 5;
const TARGET_SETS = 3;
const STORAGE_KEY = "gymData";

let activeExercise = null;
let lastAction = null;

function todayKey() {
  const d = new Date();
  const y = d.getFullYear();
  const m = String(d.getMonth() + 1).padStart(2, "0");
  const day = String(d.getDate()).padStart(2, "0");
  return `${y}-${m}-${day}`;
}

function mmdd(key) {
  const [,m,d] = key.split("-");
  return `${m}/${d}`;
}

const data = JSON.parse(localStorage.getItem(STORAGE_KEY) || "{}");
const today = todayKey();
data[today] ??= {};
const draft = {};

function save() {
  localStorage.setItem(STORAGE_KEY, JSON.stringify(data));
}

function initDraft(ex) {
  if (draft[ex]) return;
  const last = lastWorkout(ex)?.sets.at(-1);
  draft[ex] = {
    weight: last?.weight ?? 50,
    reps: last?.reps ?? 12
  };
}

function lastWorkout(ex) {
  return Object.keys(data)
    .filter(d => d !== today && data[d][ex]?.length)
    .sort()
    .reverse()
    .map(d => ({ date: d, sets: data[d][ex] }))[0] || null;
}

/* ---------- PR helpers ---------- */

function historicalStats(ex) {
  let wsmw = null;
  let bestReps = null;
  let bestDate = null;

  for (const d of Object.keys(data)) {
    if (d === today) continue;
    for (const s of data[d][ex] || []) {
      if (s.reps >= 6 && s.reps <= 12) {
        if (wsmw === null || s.weight > wsmw) {
          wsmw = s.weight;
        }
      }
    }
  }

  if (wsmw !== null) {
    for (const d of Object.keys(data)) {
      if (d === today) continue;
      for (const s of data[d][ex] || []) {
        if (s.weight >= wsmw) {
          if (bestReps === null || s.reps > bestReps) {
            bestReps = s.reps;
            bestDate = d;
          }
        }
      }
    }
  }

  return { wsmw, bestReps, bestDate };
}

function addSetClass(n) {
  if (n === 0) return "add-ready";
  if (n < TARGET_SETS) return "add-in-progress";
  return "add-complete";
}

function haptic() {
  navigator.vibrate?.(20);
}

function render() {
  document.getElementById("header").textContent = `Workout — ${today}`;

  const app = document.getElementById("app");
  app.innerHTML = "";

  for (const ex of EXERCISES) {
    initDraft(ex);
    const todaySets = data[today][ex] || [];
    const last = lastWorkout(ex);
    const stats = historicalStats(ex);

    const card = document.createElement("div");
    card.className = "card";
    if (ex === activeExercise) card.classList.add("active");

    const historyLine = `
      <div class="history">
        Last: ${last ? last.sets.map(s => `${s.reps}×${s.weight}`).join(", ") : "—"}
        ${stats.wsmw !== null ? `; <span class="best">Best: ${stats.bestReps}×${stats.wsmw} (${mmdd(stats.bestDate)})</span>` : ""}
      </div>
    `;

    const renderedSets = todaySets.map(s => {
      let repPR = false, wtPR = false;
      if (stats.wsmw !== null) {
        if (s.weight > stats.wsmw && s.reps >= 6 && s.reps <= 12) wtPR = true;
        if (s.weight >= stats.wsmw && stats.bestReps !== null && s.reps > stats.bestReps) repPR = true;
      }
      const cls = repPR || wtPR ? "pr" : "";
      const reps = repPR ? `<u>${s.reps}</u>` : s.reps;
      const weight = wtPR ? `<u>${s.weight}</u>` : s.weight;
      return `<span class="${cls}">${reps}×${weight}</span>`;
    }).join(", ");

    card.innerHTML = `
      <div class="title">${ex}</div>
      ${historyLine}

      <div class="row">
        <button onclick="adjust('${ex}','weight',-1)">−</button>
        <div class="value">${draft[ex].weight} lb</div>
        <button onclick="adjust('${ex}','weight',1)">+</button>
        <button class="add-set ${addSetClass(todaySets.length)}" onclick="addSet('${ex}')">Add Set</button>
      </div>

      <div class="row">
        <button onclick="adjust('${ex}','reps',-1)">−</button>
        <div class="value">${draft[ex].reps} reps</div>
        <button onclick="adjust('${ex}','reps',1)">+</button>
      </div>

      <div class="set-list">${renderedSets}</div>
    `;

    app.appendChild(card);
  }
}

function adjust(ex, field, dir) {
  if (field === "weight") {
    draft[ex].weight = Math.max(5, draft[ex].weight + dir * WEIGHT_STEP);
  } else {
    draft[ex].reps = Math.max(1, draft[ex].reps + dir);
  }
  render();
}

function addSet(ex) {
  data[today][ex] ??= [];
  data[today][ex].push({ ...draft[ex] });
  save();
  activeExercise = ex;
  lastAction = { ex };
  haptic();
  render();
}

function undoLast() {
  if (!lastAction) return;
  data[today][lastAction.ex].pop();
  save();
  lastAction = null;
  render();
}

render();
</script>

</body>
</html>
