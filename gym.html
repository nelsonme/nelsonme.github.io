<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Gym Tracker</title>

<style>
  body {
    font-family: system-ui, -apple-system, BlinkMacSystemFont, sans-serif;
    background: #0b0b0b;
    color: #f0f0f0;
    margin: 0;
    padding: 12px;
  }

  h1 {
    font-size: 18px;
    margin-bottom: 12px;
  }

  .card {
    background: #161616;
    border-radius: 14px;
    padding: 14px;
    margin-bottom: 14px;
    box-shadow: 0 0 0 1px rgba(255,255,255,0.05);
  }

  .title {
    font-size: 14px;
    opacity: 0.9;
  }

  .last {
    font-size: 12px;
    opacity: 0.5;
    margin-bottom: 8px;
  }

  .row {
    display: flex;
    align-items: center;
    gap: 8px;
    margin-bottom: 6px;
  }

  button {
    background: #2a2a2a;
    color: #fff;
    border: none;
    border-radius: 8px;
    width: 36px;
    height: 36px;
    font-size: 18px;
  }

  button:active {
    background: #3a3a3a;
  }

  .value {
    min-width: 80px;
    text-align: center;
    font-size: 16px;
  }

  .add-set {
    background: #0aa95c;
    color: #000;
    font-weight: 600;
    width: 110px;
    height: 44px;
    margin-left: auto;
    border-radius: 12px;
  }

  .set-list {
    font-size: 13px;
    opacity: 0.8;
    margin-top: 6px;
  }

  /* Toast */
  .toast {
    position: fixed;
    bottom: 18px;
    left: 50%;
    transform: translateX(-50%);
    background: #2a2a2a;
    padding: 10px 14px;
    border-radius: 10px;
    display: flex;
    align-items: center;
    gap: 14px;
    opacity: 0;
    pointer-events: none;
    transition: opacity 0.25s ease;
    box-shadow: 0 8px 24px rgba(0,0,0,0.4);
  }

  .toast.show {
    opacity: 1;
    pointer-events: auto;
  }

  .toast button {
    width: auto;
    height: auto;
    padding: 4px 10px;
    font-size: 13px;
    background: #444;
  }
</style>
</head>

<body>

<h1>Workout</h1>
<div id="app"></div>

<div id="toast" class="toast">
  <span id="toastText">Set added</span>
  <button onclick="undoLast()">Undo</button>
</div>

<script>
const EXERCISES = [
  "Leg Press", "Leg Curl", "Leg Extension",
  "Bicep Curl", "Tricep Extension", "Shoulder Press",
  "Chest Press", "Lat Pulldown", "Machine Row",
  "Abdominal Curl"
];

const WEIGHT_STEP = 5;
const DISMISS_MS = 5000;

let lastAction = null;
let toastTimer = null;

function todayKey() {
  const d = new Date();
  return `${d.getFullYear()}-${d.getMonth()+1}-${d.getDate()}`;
}

const storageKey = "gymData";
const data = JSON.parse(localStorage.getItem(storageKey) || "{}");
const today = todayKey();
data[today] ??= {};

// --- draft state (THIS IS THE FIX) ---
const draft = {};

function lastWorkout(ex) {
  const days = Object.keys(data).filter(d => d !== today).sort().reverse();
  for (const d of days) {
    if (data[d][ex]?.length) return data[d][ex];
  }
  return [];
}

function initDraft(ex) {
  if (draft[ex]) return;
  const last = lastWorkout(ex);
  draft[ex] = {
    weight: last.at(-1)?.weight ?? 50,
    reps: last.at(-1)?.reps ?? 12
  };
}

function save() {
  localStorage.setItem(storageKey, JSON.stringify(data));
}

function render() {
  const app = document.getElementById("app");
  app.innerHTML = "";

  EXERCISES.forEach(ex => {
    initDraft(ex);
    const sets = data[today][ex] || [];
    const last = lastWorkout(ex);

    const card = document.createElement("div");
    card.className = "card";

    card.innerHTML = `
      <div class="title">${ex}</div>
      <div class="last">Last: ${last.map(s => `${s.reps}×${s.weight}`).join(", ") || "—"}</div>

      <div class="row">
        <button onclick="adjust('${ex}','weight',-1)">−</button>
        <div class="value">${draft[ex].weight} lb</div>
        <button onclick="adjust('${ex}','weight',1)">+</button>

        <button class="add-set" onclick="addSet('${ex}')">Add Set</button>
      </div>

      <div class="row">
        <button onclick="adjust('${ex}','reps',-1)">−</button>
        <div class="value">${draft[ex].reps} reps</div>
        <button onclick="adjust('${ex}','reps',1)">+</button>
      </div>

      <div class="set-list">
        ${sets.map(s => `${s.reps}×${s.weight}`).join(", ")}
      </div>
    `;

    app.appendChild(card);
  });
}

function adjust(ex, field, dir) {
  if (field === "weight") {
    draft[ex].weight = Math.max(5, draft[ex].weight + dir * WEIGHT_STEP);
  } else {
    draft[ex].reps = Math.max(1, draft[ex].reps + dir);
  }
  render();
}

function addSet(ex) {
  data[today][ex] ??= [];
  const set = { ...draft[ex] };
  data[today][ex].push(set);
  save();

  lastAction = { ex };
  showToast("Set added");
  render();
}

function undoLast() {
  if (!lastAction) return;
  const { ex } = lastAction;
  data[today][ex].pop();
  save();
  lastAction = null;
  hideToast();
  render();
}

function showToast(text) {
  const toast = document.getElementById("toast");
  document.getElementById("toastText").textContent = text;
  toast.classList.add("show");
  clearTimeout(toastTimer);
  toastTimer = setTimeout(hideToast, DISMISS_MS);
}

function hideToast() {
  document.getElementById("toast").classList.remove("show");
  lastAction = null;
}

render();
</script>

</body>
</html>
